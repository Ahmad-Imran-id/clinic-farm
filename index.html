<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Clinic & Pharmacy Dashboard</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
    import {
      getFirestore,
      collection,
      addDoc,
      getDocs,
      query,
      where
    } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";
    import {
      getAuth,
      signInWithEmailAndPassword,
      createUserWithEmailAndPassword,
      onAuthStateChanged,
      signOut
    } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";

    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBcTCTzVAHZFyCZH5wiL0f8bpZVwy-gG4o",
      authDomain: "clinic-farm.firebaseapp.com",
      projectId: "clinic-farm",
      storageBucket: "clinic-farm.firebasestorage.app",
      messagingSenderId: "914634948650",
      appId: "1:914634948650:web:0cd9c9dd7b59a6995a0353",
      measurementId: "G-CX0SHLQ8MW"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // Function to add patient data
    async function addPatient(e) {
      e.preventDefault();
      const name = document.getElementById("p-name").value;
      const age = parseInt(document.getElementById("p-age").value);
      const gender = document.getElementById("p-gender").value;
      const diagnosis = document.getElementById("p-diagnosis").value;

      const user = auth.currentUser;
      if (user) {
        await addDoc(collection(db, "patients"), {
          uid: user.uid,
          name,
          age,
          gender,
          diagnosis,
          visit_date: new Date(),
        });
        alert("Patient added!");
      } else {
        alert("You must be logged in to add a patient.");
      }
    }

    // Function to add medicine data
    async function addMedicine(e) {
      e.preventDefault();
      const medicine_name = document.getElementById("m-name").value;
      const quantity = parseInt(document.getElementById("m-quantity").value);
      const expiry_date = document.getElementById("m-expiry").value;
      const supplier = document.getElementById("m-supplier").value;

      const user = auth.currentUser;
      if (user) {
        await addDoc(collection(db, "inventory"), {
          uid: user.uid,
          medicine_name,
          quantity,
          expiry_date: new Date(expiry_date),
          supplier,
        });
        alert("Medicine added!");
      } else {
        alert("You must be logged in to add a medicine.");
      }
    }

    // Function to load data based on logged-in user
    async function loadUserData() {
      const user = auth.currentUser;

      if (user) {
        // Retrieve patient data for the logged-in user
        const patientQuery = query(collection(db, "patients"), where("uid", "==", user.uid));
        const patientSnapshot = await getDocs(patientQuery);
        patientSnapshot.forEach(doc => {
          console.log(doc.data()); // Add logic to display data in your table
        });

        // Retrieve medicine data for the logged-in user
        const medicineQuery = query(collection(db, "inventory"), where("uid", "==", user.uid));
        const medicineSnapshot = await getDocs(medicineQuery);
        medicineSnapshot.forEach(doc => {
          console.log(doc.data()); // Add logic to display data in your table
        });
      }
    }

    // Login function
    async function loginUser(e) {
      e.preventDefault();
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;

      try {
        await signInWithEmailAndPassword(auth, email, password);
        loadUserData(); // Load data after login
      } catch (error) {
        alert("Login failed: " + error.message);
      }
    }

    // Logout function
    async function logoutUser() {
      await signOut(auth);
      document.getElementById("login-form").style.display = "block";
      document.getElementById("dashboard").style.display = "none";
      document.getElementById("logout-button").style.display = "none";
    }

    // Monitor authentication state
    onAuthStateChanged(auth, (user) => {
      if (user) {
        document.getElementById("login-form").style.display = "none";
        document.getElementById("dashboard").style.display = "block";
        document.getElementById("logout-button").style.display = "inline";
        loadUserData(); // Load user-specific data
      } else {
        document.getElementById("login-form").style.display = "block";
        document.getElementById("dashboard").style.display = "none";
        document.getElementById("logout-button").style.display = "none";
      }
    });

    // Event Listeners for Forms
    document.getElementById("patient-form").addEventListener("submit", addPatient);
    document.getElementById("medicine-form").addEventListener("submit", addMedicine);
    document.getElementById("login-form").addEventListener("submit", loginUser);
    document.getElementById("logout-button").addEventListener("click", logoutUser);
  </script>

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      padding: 20px;
      max-width: 800px;
      margin: auto;
    }
    form {
      border: 1px solid #ccc;
      padding: 20px;
      margin-bottom: 30px;
      border-radius: 8px;
    }
    input, select, button {
      display: block;
      margin-top: 10px;
      width: 100%;
      padding: 8px;
    }
    #dashboard {
      display: none;
    }
    #logout-button {
      display: none;
    }
  </style>
  
</head>
<body>
  <h1>Clinic & Pharmacy Dashboard</h1>

  <!-- Login Form -->
  <div id="login-form">
    <h2>Login</h2>
    <input type="email" id="email" placeholder="Email" required />
    <input type="password" id="password" placeholder="Password" required />
    <button type="submit">Login</button>
  </div>

  <!-- Dashboard (hidden until login) -->
  <div id="dashboard">
    <form id="patient-form">
      <h2>Add Patient</h2>
      <input id="p-name" type="text" placeholder="Name" required />
      <input id="p-age" type="number" placeholder="Age" required />
      <select id="p-gender" required>
        <option value="">Select Gender</option>
        <option value="Male">Male</option>
        <option value="Female">Female</option>
      </select>
      <input id="p-diagnosis" type="text" placeholder="Diagnosis" required />
      <button type="submit">Add Patient</button>
    </form>

    <form id="medicine-form">
      <h2>Add Medicine</h2>
      <input id="m-name" type="text" placeholder="Medicine Name" required />
      <input id="m-quantity" type="number" placeholder="Quantity" required />
      <input id="m-expiry" type="date" required />
      <input id="m-supplier" type="text" placeholder="Supplier" required />
      <button type="submit">Add Medicine</button>
    </form>

    <!-- Logout Button -->
    <button id="logout-button">Logout</button>
  </div>

  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js"></script>
</body>
</html>
